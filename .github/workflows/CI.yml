
name: Deploy APISIX Declarative Config

on:
  push:
    branches: [ main ]


jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Validate file exists
        run: |
          ls -lah apisix.yaml
      
      - name: Download and Install ADC
        run: |
          echo "Downloading APISIX Declarative CLI (ADC) v0.12.0"
          wget -q "https://github.com/api7/adc/releases/download/v0.12.0/adc_0.12.0_linux_amd64.tar.gz"
          tar -xzf "adc_0.12.0_linux_amd64.tar.gz"
          chmod +x adc
          sudo mv adc /usr/local/bin/
          rm adc_0.12.0_linux_amd64.tar.gz
      
      - name: Verify ADC Installation
        run: |
          adc -V
          echo "ADC installed successfully"
      
      - name: Test APISIX Connectivity
        env:
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "Testing connection to APISIX"
          adc ping \
            --backend apisix \
            --server http://localhost:9180 \
            --token "$edd1c9f034335f136f87ad84b625c8f1"
      
      - name: Apply APISIX Declarative Config
        env:
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "Applying APISIX declarative config with ADC"
          adc sync -f apisix.yaml \
            --backend apisix \
            --server http://localhost:9180 \
            --token "edd1c9f034335f136f87ad84b625c8f1"
          echo "Configuration applied successfully!"
