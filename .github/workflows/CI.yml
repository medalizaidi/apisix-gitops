name: Deploy APISIX Configuration

on:
  push:
    branches: [ main ]
    paths:
      - 'routes/**'
      - 'services/**'
      - 'upstreams/**'
      - 'stream_routes/**'

jobs:
  # Detect which files changed
  detect-changes:
    runs-on: self-hosted
    outputs:
      routes: ${{ steps.filter.outputs.routes }}
      services: ${{ steps.filter.outputs.services }}
      upstreams: ${{ steps.filter.outputs.upstreams }}
      stream_routes: ${{ steps.filter.outputs.stream_routes }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Detect changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            routes:
              - 'routes/**'
            services:
              - 'services/**'
            upstreams:
              - 'upstreams/**'
            stream_routes:
              - 'stream_routes/**'

  # Deploy Upstreams First
  deploy-upstreams:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.upstreams == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Deploy Upstreams
        env:
          APISIX_ADMIN_URL: http://localhost:9180
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "üîó Deploying Upstreams..."
          
          for file in upstreams/*.json; do
            if [ -f "$file" ]; then
              upstream_id=$(basename "$file" .json)
              echo "üì° Applying upstream: $upstream_id"
              
              response=$(curl -s -w "\n%{http_code}" -X PUT \
                "${APISIX_ADMIN_URL}/apisix/admin/upstreams/${upstream_id}" \
                -H "X-API-KEY: ${APISIX_ADMIN_KEY}" \
                -H "Content-Type: application/json" \
                -d @"$file")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "‚úÖ Success: $upstream_id"
              else
                echo "‚ùå Failed: $upstream_id ($http_code)"
                echo "$body"
                exit 1
              fi
              echo ""
            fi
          done

  # Deploy Services
  deploy-services:
    runs-on: self-hosted
    needs: [detect-changes, deploy-upstreams]
    if: |
      always() && 
      needs.detect-changes.outputs.services == 'true' &&
      (needs.deploy-upstreams.result == 'success' || needs.deploy-upstreams.result == 'skipped')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Deploy Services
        env:
          APISIX_ADMIN_URL: http://localhost:9180
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "üì¶ Deploying Services..."
          
          for file in services/*.json; do
            if [ -f "$file" ]; then
              service_id=$(basename "$file" .json)
              echo "üì° Applying service: $service_id"
              
              response=$(curl -s -w "\n%{http_code}" -X PUT \
                "${APISIX_ADMIN_URL}/apisix/admin/services/${service_id}" \
                -H "X-API-KEY: ${APISIX_ADMIN_KEY}" \
                -H "Content-Type: application/json" \
                -d @"$file")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "‚úÖ Success: $service_id"
              else
                echo "‚ùå Failed: $service_id ($http_code)"
                echo "$body"
                exit 1
              fi
              echo ""
            fi
          done

  # Deploy Routes
  deploy-routes:
    runs-on: self-hosted
    needs: [detect-changes, deploy-upstreams, deploy-services]
    if: |
      always() && 
      needs.detect-changes.outputs.routes == 'true' &&
      (needs.deploy-upstreams.result == 'success' || needs.deploy-upstreams.result == 'skipped') &&
      (needs.deploy-services.result == 'success' || needs.deploy-services.result == 'skipped')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Deploy Routes
        env:
          APISIX_ADMIN_URL: http://localhost:9180
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "üõ£Ô∏è  Deploying Routes..."
          
          for file in routes/*.json; do
            if [ -f "$file" ]; then
              route_id=$(basename "$file" .json)
              echo "üì° Applying route: $route_id"
              
              response=$(curl -s -w "\n%{http_code}" -X PUT \
                "${APISIX_ADMIN_URL}/apisix/admin/routes/${route_id}" \
                -H "X-API-KEY: ${APISIX_ADMIN_KEY}" \
                -H "Content-Type: application/json" \
                -d @"$file")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "‚úÖ Success: $route_id"
              else
                echo "‚ùå Failed: $route_id ($http_code)"
                echo "$body"
                exit 1
              fi
              echo ""
            fi
          done

  # Deploy Stream Routes
  deploy-stream-routes:
    runs-on: self-hosted
    needs: [detect-changes, deploy-upstreams]
    if: |
      always() && 
      needs.detect-changes.outputs.stream_routes == 'true' &&
      (needs.deploy-upstreams.result == 'success' || needs.deploy-upstreams.result == 'skipped')
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Deploy Stream Routes
        env:
          APISIX_ADMIN_URL: http://localhost:9180
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "üåä Deploying Stream Routes..."
          
          for file in stream_routes/*.json; do
            if [ -f "$file" ]; then
              route_id=$(basename "$file" .json)
              echo "üì° Applying stream route: $route_id"
              
              response=$(curl -s -w "\n%{http_code}" -X PUT \
                "${APISIX_ADMIN_URL}/apisix/admin/stream_routes/${route_id}" \
                -H "X-API-KEY: ${APISIX_ADMIN_KEY}" \
                -H "Content-Type: application/json" \
                -d @"$file")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "‚úÖ Success: $route_id"
              else
                echo "‚ùå Failed: $route_id ($http_code)"
                echo "$body"
                exit 1
              fi
              echo ""
            fi
          done

  # Verify Deployment
  verify:
    runs-on: self-hosted
    needs: [deploy-routes, deploy-services, deploy-upstreams, deploy-stream-routes]
    if: always()
    steps:
      - name: Verify Deployment
        env:
          APISIX_ADMIN_URL: http://localhost:9180
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          echo "üîç Verifying deployment..."
          echo ""
          
          echo "üìä Deployment Summary:"
          echo "===================="
          echo "Upstreams: ${{ needs.deploy-upstreams.result }}"
          echo "Services: ${{ needs.deploy-services.result }}"
          echo "Routes: ${{ needs.deploy-routes.result }}"
          echo "Stream Routes: ${{ needs.deploy-stream-routes.result }}"
          echo ""
          
          echo "‚úÖ Verification complete"