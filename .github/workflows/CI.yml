

name: Deploy APISIX Declarative Config

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Validate file exists
        run: |
          ls -lah apisix.yaml
      
      - name: Install Python dependencies
        run: |
          pip3 install pyyaml requests --break-system-packages || pip3 install pyyaml requests
      
      - name: Apply APISIX Configuration
        env:
          APISIX_ADMIN_KEY: ${{ secrets.APISIX_ADMIN_KEY }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import requests
          import json
          import os
          import sys
          
          ADMIN_URL = "http://localhost:9180"
          API_KEY = os.environ.get('APISIX_ADMIN_KEY', 'edd1c9f034335f136f87ad84b625c8f1')
          
          headers = {
              "X-API-KEY": API_KEY,
              "Content-Type": "application/json"
          }
          
          def apply_resource(resource_type, resource_id, data):
              """Apply a resource to APISIX"""
              url = f"{ADMIN_URL}/apisix/admin/{resource_type}/{resource_id}"
              try:
                  response = requests.put(url, headers=headers, json=data, timeout=5)
                  if response.status_code in [200, 201]:
                      print(f"✓ {resource_type.upper()} {resource_id}: Success")
                      return True
                  else:
                      print(f"✗ {resource_type.upper()} {resource_id}: Failed ({response.status_code})")
                      print(f"  Response: {response.text}")
                      return False
              except Exception as e:
                  print(f"✗ {resource_type.upper()} {resource_id}: Error - {str(e)}")
                  return False
          
          # Load YAML config
          try:
              with open('apisix.yaml', 'r') as f:
                  config = yaml.safe_load(f)
          except Exception as e:
              print(f"✗ Failed to load apisix.yaml: {e}")
              sys.exit(1)
          
          success_count = 0
          total_count = 0
          
          # Apply upstreams first (dependencies for routes)
          if 'upstreams' in config:
              print("\n=== Applying Upstreams ===")
              for upstream in config['upstreams']:
                  total_count += 1
                  upstream_id = upstream.pop('id')
                  if apply_resource('upstreams', upstream_id, upstream):
                      success_count += 1
          
          # Apply stream_upstreams
          if 'stream_upstreams' in config:
              print("\n=== Applying Stream Upstreams ===")
              for upstream in config['stream_upstreams']:
                  total_count += 1
                  upstream_id = upstream.pop('id')
                  if apply_resource('stream_upstreams', upstream_id, upstream):
                      success_count += 1
          
          # Apply services
          if 'services' in config:
              print("\n=== Applying Services ===")
              for service in config['services']:
                  total_count += 1
                  service_id = service.pop('id')
                  if apply_resource('services', service_id, service):
                      success_count += 1
          
          # Apply consumers
          if 'consumers' in config:
              print("\n=== Applying Consumers ===")
              for consumer in config['consumers']:
                  total_count += 1
                  username = consumer.get('username')
                  if apply_resource('consumers', username, consumer):
                      success_count += 1
          
          # Apply routes
          if 'routes' in config:
              print("\n=== Applying Routes ===")
              for route in config['routes']:
                  total_count += 1
                  route_id = route.pop('id')
                  if apply_resource('routes', route_id, route):
                      success_count += 1
          
          # Apply stream_routes
          if 'stream_routes' in config:
              print("\n=== Applying Stream Routes ===")
              for route in config['stream_routes']:
                  total_count += 1
                  route_id = route.pop('id')
                  if apply_resource('stream_routes', route_id, route):
                      success_count += 1
          
          # Apply global_rules
          if 'global_rules' in config:
              print("\n=== Applying Global Rules ===")
              for rule in config['global_rules']:
                  total_count += 1
                  rule_id = rule.pop('id')
                  if apply_resource('global_rules', rule_id, rule):
                      success_count += 1
          
          # Summary
          print(f"\n{'='*50}")
          print(f"Configuration Applied: {success_count}/{total_count} resources succeeded")
          print(f"{'='*50}")
          
          if success_count < total_count:
              sys.exit(1)
          PYTHON_SCRIPT
